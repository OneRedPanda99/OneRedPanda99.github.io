<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <title>Handwriting Data Collector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
            height: 100%;
            max-width: 1024px;
            max-height: 768px;
            animation: slideUp 0.6s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .progress-section {
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .sentence-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        .sentence-text {
            font-size: 1.2rem;
            color: #333;
            line-height: 1.4;
            font-weight: 600;
        }

        .canvas-container {
            border: 3px solid #667eea;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
            position: relative;
            overflow: hidden;
            flex: 1;
            min-height: 200px;
        }

        #drawingCanvas, #guidelineCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            touch-action: none;
        }

        .guidelines {
            pointer-events: none;
            opacity: 0.3;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        @media (orientation: landscape) and (min-width: 768px) {
            .controls {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:active {
            transform: scale(0.98);
            background: #c82333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* iPad-specific optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                padding: 25px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .sentence-text {
                font-size: 1.4rem;
            }
            
            .btn {
                padding: 14px 18px;
                font-size: 1rem;
            }
            
            .stat-number {
                font-size: 1.4rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
        }

        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px;
            font-size: 10px;
            border-radius: 3px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="debug-info" id="debugInfo">Debug info</div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">Handwriting Collector</h1>
            <p class="subtitle">Train your personal AI handwriting model</p>
        </div>

        <div class="progress-section">
            <div class="progress-label">
                <span>Training Progress</span>
                <span><span id="currentSample">0</span> / <span id="targetSamples">500</span> samples</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="sentence-display">
            <p class="sentence-text" id="sentenceText">The quick brown fox jumps over the lazy dog.</p>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="drawingCanvas"></canvas>
            <canvas class="guidelines" id="guidelineCanvas"></canvas>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="nextBtn">Next Sentence</button>
            <button class="btn btn-secondary" id="clearBtn">Clear</button>
            <button class="btn btn-secondary" id="guidelinesBtn">Toggle Guidelines</button>
            <button class="btn btn-danger" id="exportBtn">Export Data</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-number" id="totalStrokes">0</span>
                <div class="stat-label">Total Strokes</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalWords">0</span>
                <div class="stat-label">Words Written</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="sessionTime">0m</span>
                <div class="stat-label">Session Time</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="dataSize">0KB</span>
                <div class="stat-label">Data Collected</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let canvas, ctx, guidelineCanvas, guidelineCtx;
        let isDrawing = false;
        let currentStroke = [];
        let allStrokes = [];
        let currentSampleData = [];
        let sampleCount = 0;
        let targetSamples = 500;
        let startTime = Date.now();
        let totalStrokes = 0;
        let showGuidelines = true;
        let debugMode = false;

        const sentences = [
            "Netflix and chill vibes", "Main character energy", "That hits different though",
            "No cap this is fire", "Living my best life", "Touch grass immediately",
            "Big mood honestly", "This is not it chief", "Sending good vibes only",
            "Manifesting success today", "Pizza at midnight hits different", 
            "Coffee before conversation please", "Tacos solve everything always",
            "Ice cream for breakfast", "Pasta is my love language", 
            "Chocolate fixes bad days", "Avocado toast generation represent",
            "Spicy food builds character", "Cereal is acceptable dinner",
            "Cookies make everything better", "My plants are judging me",
            "Socks disappear in dryers", "Monday energy is questionable",
            "Procrastination is my superpower", "Adulting is highly overrated",
            "Sleep is for winners", "Chaos is my natural state",
            "Cats have secret meetings", "WiFi password is everything",
            "Laundry breeds when ignored", "Dream big work harder",
            "Create your own sunshine", "Adventure awaits beyond comfort",
            "Growth happens outside zones", "Believe in your weird",
            "Magic happens when trying", "Progress over perfection always",
            "Kindness is always trendy", "Your vibe attracts tribe",
            "Courage over comfort zone", "WiFi stronger than relationships",
            "Googling everything is normal", "Phone battery anxiety real",
            "Screenshot for evidence always", "Airplane mode saves sanity",
            "Password must contain soul", "Update later means never",
            "Bluetooth pairing is witchcraft", "Cloud storage saves lives",
            "Autocorrect creates chaos daily", "Clouds look like thoughts",
            "Music speaks without words", "Books are portable magic",
            "Dancing requires no audience", "Laughter is contagious medicine",
            "Stars shine despite darkness", "Waves whisper ancient secrets",
            "Time flies without permission", "Colors have hidden emotions",
            "Silence speaks volumes sometimes", "Penguins wear natural tuxedos",
            "Unicorns are just shy", "Dragons collect vintage teacups",
            "Robots dream of pizza", "Aliens prefer pineapple pizza",
            "Mermaids use waterproof makeup", "Wizards struggle with technology",
            "Ninjas order food quietly", "Pirates use GPS now",
            "Vampires avoid ring lights", "Autumn leaves whisper secrets",
            "Winter demands cozy vibes", "Spring brings fresh possibilities",
            "Summer energy is unmatched", "Rain sounds like meditation",
            "Snow days feel magical", "Sunshine fixes almost everything",
            "Thunderstorms are nature's concerts", "Rainbows appear after storms",
            "Fog creates mysterious mornings"
        ];
        
        

        function debug(msg) {
            if (debugMode) {
                console.log(msg);
                const debugEl = document.getElementById('debugInfo');
                debugEl.textContent = msg;
                debugEl.style.display = 'block';
            }
        }

        // Initialize the application
        function init() {
            debug('Initializing...');
            
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            guidelineCanvas = document.getElementById('guidelineCanvas');
            guidelineCtx = guidelineCanvas.getContext('2d');

            resizeCanvas();
            setupCanvas();
            drawGuidelines();
            updateStats();
            loadRandomSentence();

            // Event listeners with better iPad support
            setupEventListeners();
            
            debug('Initialization complete');
        }

        function setupEventListeners() {
            // Prevent default touch behaviors on the entire document
            document.addEventListener('touchstart', (e) => {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchend', (e) => {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Touch events for drawing (primary for iPad)
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });

            // Mouse events for desktop testing
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseout', handleMouseUp);

            // Button event listeners
            document.getElementById('nextBtn').addEventListener('click', nextSentence);
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('guidelinesBtn').addEventListener('click', toggleGuidelines);
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // Handle orientation changes and resize
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    resizeCanvas();
                    drawGuidelines();
                }, 200);
            });

            window.addEventListener('resize', () => {
                setTimeout(() => {
                    resizeCanvas();
                    drawGuidelines();
                }, 100);
            });

            // Enable debug mode with triple tap
            let tapCount = 0;
            canvas.addEventListener('touchend', (e) => {
                tapCount++;
                if (tapCount >= 3) {
                    debugMode = !debugMode;
                    debug(debugMode ? 'Debug mode ON' : 'Debug mode OFF');
                    tapCount = 0;
                }
                setTimeout(() => { tapCount = 0; }, 1000);
            });
        }

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            const rect = container.getBoundingClientRect();
            
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);
            
            canvas.width = width;
            canvas.height = height;
            guidelineCanvas.width = width;
            guidelineCanvas.height = height;
            
            debug(`Canvas resized to ${width}x${height}`);
            
            setupCanvas();
        }

        function setupCanvas() {
            ctx.strokeStyle = '#333';
            ctx.fillStyle = '#333';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            // Improve smoothness
            ctx.imageSmoothingEnabled = true;
        }

        function getEventPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            return { x, y };
        }

        // Touch event handlers
        function handleTouchStart(e) {
            e.preventDefault();
            debug('Touch start');
            const pos = getEventPos(e);
            startDrawing(pos);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const pos = getEventPos(e);
            draw(pos);
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            debug('Touch end');
            stopDrawing();
        }

        // Mouse event handlers (for desktop testing)
        function handleMouseDown(e) {
            const pos = getEventPos(e);
            startDrawing(pos);
        }

        function handleMouseMove(e) {
            if (!isDrawing) return;
            const pos = getEventPos(e);
            draw(pos);
        }

        function handleMouseUp(e) {
            stopDrawing();
        }

        function startDrawing(pos) {
            isDrawing = true;
            currentStroke = [];
            
            currentStroke.push({x: pos.x, y: pos.y, time: Date.now()});
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            
            debug(`Drawing started at ${pos.x}, ${pos.y}`);
        }

        function draw(pos) {
            if (!isDrawing) return;
            
            // Distance-based filtering for smoother lines
            if (currentStroke.length > 0) {
                const lastPoint = currentStroke[currentStroke.length - 1];
                const distance = Math.sqrt((pos.x - lastPoint.x) ** 2 + (pos.y - lastPoint.y) ** 2);
                
                if (distance < 2.0) return;
            }
            
            currentStroke.push({x: pos.x, y: pos.y, time: Date.now()});
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            
            debug(`Stroke completed with ${currentStroke.length} points`);
            
            if (currentStroke.length > 1) {
                allStrokes.push([...currentStroke]);
                totalStrokes++;
                updateStats();
            }
        }

        function drawGuidelines() {
            if (!showGuidelines) return;
            
            guidelineCtx.clearRect(0, 0, guidelineCanvas.width, guidelineCanvas.height);
            
            const height = guidelineCanvas.height;
            const width = guidelineCanvas.width;
            
            const baselineY = height * 0.7;
            const topLineY = height * 0.3;
            const middleLineY = height * 0.5;
            const descenderLineY = height * 0.85;
            
            const leftMargin = 30;
            const rightMargin = width - 30;

            // Draw horizontal guidelines
            guidelineCtx.strokeStyle = '#666666';
            guidelineCtx.lineWidth = 1;
            
            // Baseline
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(leftMargin, baselineY);
            guidelineCtx.lineTo(rightMargin, baselineY);
            guidelineCtx.stroke();

            // Top line
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(leftMargin, topLineY);
            guidelineCtx.lineTo(rightMargin, topLineY);
            guidelineCtx.stroke();

            // Descender line
            guidelineCtx.strokeStyle = '#999999';
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(leftMargin, descenderLineY);
            guidelineCtx.lineTo(rightMargin, descenderLineY);
            guidelineCtx.stroke();

            // Middle line (dashed)
            guidelineCtx.strokeStyle = '#bbbbbb';
            guidelineCtx.setLineDash([5, 5]);
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(leftMargin, middleLineY);
            guidelineCtx.lineTo(rightMargin, middleLineY);
            guidelineCtx.stroke();
            guidelineCtx.setLineDash([]);

            // Vertical margins
            guidelineCtx.strokeStyle = '#666666';
            guidelineCtx.lineWidth = 2;
            
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(leftMargin, topLineY - 10);
            guidelineCtx.lineTo(leftMargin, descenderLineY + 10);
            guidelineCtx.stroke();
            
            guidelineCtx.beginPath();
            guidelineCtx.moveTo(rightMargin, topLineY - 10);
            guidelineCtx.lineTo(rightMargin, descenderLineY + 10);
            guidelineCtx.stroke();
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            totalStrokes = totalStrokes - allStrokes.length;
            allStrokes = [];
            updateStats();
            debug('Canvas cleared');
        }

        function loadRandomSentence() {
            const randomIndex = Math.floor(Math.random() * sentences.length);
            document.getElementById('sentenceText').textContent = sentences[randomIndex];
        }

        function nextSentence() {
            debug('Next sentence clicked');
            
            if (allStrokes.length === 0) {
                alert('Please write the sentence first!');
                return;
            }

            const currentSentence = document.getElementById('sentenceText').textContent;
            currentSampleData.push({
                text: currentSentence,
                strokes: allStrokes.map(stroke => stroke.map(point => [point.x, point.y])),
                timestamp: Date.now()
            });

            sampleCount++;
            updateProgress();
            clearCanvas();
            loadRandomSentence();
            updateStats();
            
            debug(`Sample ${sampleCount} saved`);
        }

        function updateProgress() {
            const progress = (sampleCount / targetSamples) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentSample').textContent = sampleCount;
        }

        function toggleGuidelines() {
            showGuidelines = !showGuidelines;
            if (showGuidelines) {
                drawGuidelines();
                guidelineCanvas.style.opacity = '0.3';
            } else {
                guidelineCtx.clearRect(0, 0, guidelineCanvas.width, guidelineCanvas.height);
                guidelineCanvas.style.opacity = '0';
            }
        }

        function updateStats() {
            document.getElementById('totalStrokes').textContent = totalStrokes;
            document.getElementById('totalWords').textContent = sampleCount * 3;
            
            const sessionMinutes = Math.floor((Date.now() - startTime) / 60000);
            document.getElementById('sessionTime').textContent = sessionMinutes + 'm';
            
            const dataSize = Math.round((JSON.stringify(currentSampleData).length / 1024));
            document.getElementById('dataSize').textContent = dataSize + 'KB';
        }

        function exportData() {
            if (currentSampleData.length === 0) {
                alert('No data to export! Write some sentences first.');
                return;
            }

            const exportData = {
                metadata: {
                    totalSamples: currentSampleData.length,
                    totalStrokes: totalStrokes,
                    createdAt: new Date().toISOString(),
                    version: '1.0',
                    device: 'iPad'
                },
                samples: currentSampleData
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const fileSizeKB = Math.round(dataStr.length / 1024);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const filename = `handwriting_data_${Date.now()}.json`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const message = `✅ Exported ${currentSampleData.length} samples (${fileSizeKB}KB)\n\n📁 File: ${filename}\n\nTo save to GitHub:\n1. Upload to your repo\n2. Commit changes`;
            
            alert(message);
        }

        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Update stats periodically
        setInterval(updateStats, 30000);
    </script>
</body>
</html>
